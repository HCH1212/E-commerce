## 一、项目简介与背景

### 1.1 项目背景

随着电商业务快速发展，平台需要同时满足高并发访问、服务可扩展与稳定运维等要求。本项目基于微服务架构实现完整电商业务闭环，涵盖用户、商品、购物车、订单、支付、结账、邮件通知、权限控制与 AI 服务等模块，配套前端展示与一键启动脚本，便于本地开发与演示。

### 1.2 技术栈分析

系统采用 Go 语言与微服务治理体系构建：

- **后端服务**：Go、Kitex（RPC）、Hertz（HTTP 网关）、cwgo（代码生成）
- **数据库与缓存**：MySQL 8.0、Redis 7.0（Session）
- **中间件**：Consul（服务注册发现）、NATS（消息中间件）
- **权限控制**：Casbin（RBAC）
- **观测性**：OpenTelemetry、Prometheus、Grafana、Logrus/GLP 日志系统
- **部署**：Docker、docker-compose、Kind（K8s 集群）
- **前端**：Bootstrap（前端框架）

---

## 二、系统架构与核心机制

1. **微服务拆分**：用户、商品、购物车、订单、支付、结账、邮件、权限、AI 等服务独立部署，通过 Kitex RPC 进行服务间通信。
2. **网关与会话管理**：Frontend 服务使用 Hertz 作为 HTTP 网关，Session 统一落地 Redis，维持登录状态。
3. **服务治理与观测**：Consul 负责服务注册发现，OTel 打通链路追踪，Prometheus + Grafana 展示指标面板。
4. **权限控制**：Casbin 采用 RBAC 模型区分用户与商家权限，并通过策略文件进行统一配置。
5. **可靠性机制**：对商品服务提供熔断与 fallback，提升局部故障下的可用性。

---

## 三、主要功能模块实现

### 3.1 用户服务（user）

- **注册/登录/资料管理**：提供基础用户信息与认证接口。
- **Session 管理**：与 Redis 配合实现登录态维护。

### 3.2 商品服务（product）

- **商品 CRUD**：商品信息、分类、价格与图片维护。
- **默认数据初始化**：支持通过 `default.sql` 导入预置商品，便于快速验证功能。

### 3.3 购物车服务（cart）

- **购物车增删改查**：记录用户商品选择与数量。

### 3.4 订单与支付（order/payment）

- **订单创建与查询**：串联购物车与支付流程。
- **支付能力**：订单状态更新与支付结果同步。

### 3.5 结账与通知（checkout/email）

- **结账流程编排**：整合订单、支付与库存逻辑。
- **邮件通知**：结账成功后触发消息发送。

### 3.6 权限与 AI 服务（casbin/eino）

- **RBAC 权限控制**：区分用户与商家操作权限。
- **AI 服务扩展**：预留智能推荐或辅助能力接口。

### 3.7 前端展示（frontend）

- **Hertz + Bootstrap**：提供商品浏览、下单与支付等页面。
- **统一入口**：默认访问地址为 `http://localhost:8080`。

---

## 四、数据库与数据初始化

- **数据库拆分**：user、product、cart、order、payment 五个数据库由 `init_databases.sql` 初始化。
- **自动建表**：各服务启动时通过 GORM AutoMigrate 创建数据表结构。
- **商品默认数据**：`app/product/default.sql` 提供演示商品数据。

---

## 五、部署与运行方式

### 5.1 一键启动脚本

- `start_all.bat`：启动 Docker 基础服务与全部微服务。
- `stop_all.bat`：按依赖顺序优雅停止所有服务。

### 5.2 手动启动流程（简要）

1. `make docker` 启动基础设施（MySQL/Redis/Consul/NATS）。
2. `make init_db` 初始化数据库。
3. 依次启动 `user/product/cart/order/payment/checkout/email/casbin/eino/frontend`。
4. 可选执行 `make init_product_data` 导入商品。

### 5.3 端口与基础设施说明

- **MySQL**：3306（root / 041212）
- **Redis**：6379
- **Consul**：8500（注册中心与 UI）
- **NATS**：4222（客户端）、8222（监控）
- **Frontend**：8080（HTTP 网关与页面）

### 5.4 启动顺序与脚本特点

- `start_all.bat` 采用“基础设施 → frontend → product → 初始化数据 → 其他服务”的顺序，避免依赖未就绪。
- 每个微服务在独立终端窗口运行，便于排查日志。
- `stop_all.bat` 按依赖反向顺序关闭，并清理 Docker 容器。

---

## 六、项目结构与工程化要点

### 6.1 目录结构概览

- `app/`：各微服务实现（user、product、cart、order、payment、checkout、email、casbin、eino、frontend）
- `idl/`：服务接口 IDL 定义（Kitex / Hertz）
- `rpc_gen/`：RPC 代码生成输出目录
- `common/`：通用组件（客户端、链路追踪、服务封装）
- `deploy/`：Dockerfile 与 K8s/监控相关配置

### 6.2 代码生成与构建流程

- 使用 `cwgo` 生成 Kitex RPC 与 Hertz HTTP 代码（见 Makefile 中 `cwgo_*` 目标）。
- `make docker` 一键启动基础容器；`make init_db` 与 `make init_product_data` 负责数据初始化。

### 6.3 可观测性与日志

- 通过 OpenTelemetry 汇总链路追踪，Prometheus + Grafana 展示指标。
- 日志采用 Logrus/GLP，支持统一排查与分析。

---

## 七、总结与展望

### 7.1 项目总结

通过本项目，团队完成了完整电商微服务链路的落地实践，掌握了 Kitex/Hertz 的 RPC + HTTP 协作方式，并在服务发现、监控、权限与消息中间件方面建立了标准化工程能力。

### 7.2 不足与优化方向

- **服务治理强化**：进一步完善限流、熔断与自动扩缩容策略。
- **数据一致性**：引入事务消息或分布式事务方案，优化订单与支付一致性。
- **前端体验提升**：增加搜索、推荐与运营活动等模块。

### 7.3 收获与体会

本次实践强化了微服务协同开发与运维意识，理解了“可观测性”对排障的重要性，也在真实业务拆分与依赖管理中积累了经验。

---

**致谢**：感谢团队协作与 AI 助手在文档整理、配置核对与排错中的辅助。
